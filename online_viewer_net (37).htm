<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù‚Ø³Ù…Ø© Ù„Ù„Ø£Ø·ÙØ§Ù„ | ØªØ·Ø¨ÙŠÙ‚ ØªÙØ§Ø¹Ù„ÙŠ</title>

  <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØµÙØ­Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
  <link rel="icon" href="logo.png" type="image/png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f8ff;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:rgba(17,24,39,.10);
      --shadow: 0 12px 30px rgba(16,24,40,.10);

      --a:#5b8cff;
      --b:#22c55e;
      --c:#f59e0b;
      --d:#ef4444;
      --e:#a855f7;
      --soft:#eef2ff;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(900px 500px at 80% -10%, rgba(91,140,255,.22), transparent 55%),
        radial-gradient(900px 500px at 10% 10%, rgba(168,85,247,.18), transparent 55%),
        radial-gradient(900px 500px at 50% 110%, rgba(34,197,94,.16), transparent 60%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }

    .wrap{ max-width:1100px; margin:0 auto; padding:18px 16px 90px; }

    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:14px 14px;
      background:rgba(255,255,255,.75);
      backdrop-filter: blur(10px);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: var(--shadow);
      position:sticky; top:10px; z-index:50;
      flex-direction: row-reverse; /* Ø§Ù„Ø¹Ù†ÙˆØ§Ù†+Ø§Ù„Ø´Ø¹Ø§Ø± Ø¬Ù‡Ø© Ø§Ù„ÙŠÙ…ÙŠÙ† */
    }
    .brand{
      display:flex; align-items:center; gap:12px; min-width:260px;
      flex-direction: row-reverse; /* Ø§Ù„Ø´Ø¹Ø§Ø± ÙŠÙ…ÙŠÙ† Ø§Ù„Ù†Øµ */
    }
    .logo{
      width:46px; height:46px; border-radius:14px;
      background: linear-gradient(135deg, rgba(91,140,255,.95), rgba(168,85,247,.95));
      display:grid; place-items:center;
      box-shadow: 0 12px 25px rgba(91,140,255,.25);
      overflow:hidden;
      position:relative;
      border:1px solid rgba(255,255,255,.55);
    }
    .logo img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
      background:#fff;
    }
    .logo .fallback{
      display:none;
      color:#fff; font-weight:900; font-size:18px;
    }
    .titleBlock{ line-height:1.1; text-align:right; }
    .titleBlock h1{ margin:0; font-size:18px; }
    .titleBlock p{ margin:4px 0 0; font-size:12px; color:var(--muted); }

    .topActions{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-start; }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.7);
      font-size:12px; color:var(--muted);
      user-select:none;
    }
    .stars{ color:#f59e0b; font-weight:800; }
    .btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.85);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      transition:.15s transform, .15s background, .15s box-shadow;
      display:inline-flex; align-items:center; gap:8px;
      color:var(--text);
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 20px rgba(16,24,40,.08); }
    .btn:active{ transform: translateY(0px); }
    .btn.primary{ background: linear-gradient(135deg, rgba(91,140,255,.95), rgba(168,85,247,.90)); color:#fff; border-color:transparent; }
    .btn.good{ background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.25); }
    .btn.warn{ background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.25); }
    .btn.bad{ background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.25); }

    nav{
      margin-top:14px;
      display:flex; gap:10px; flex-wrap:wrap;
      padding:10px;
      background: rgba(255,255,255,.70);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: var(--shadow);
      justify-content:flex-end;
    }
    .tab{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.85);
      cursor:pointer;
      font-weight:800;
      display:inline-flex; gap:8px; align-items:center;
    }
    .tab.active{
      background: linear-gradient(135deg, rgba(91,140,255,.95), rgba(168,85,247,.90));
      color:#fff; border-color:transparent;
    }

    main{ margin-top:14px; }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      header{ position:static; }
    }

    .card{
      background: rgba(255,255,255,.85);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .card h2{ margin:0 0 10px; font-size:16px; }
    .card h3{ margin:0 0 10px; font-size:14px; color:var(--text); }
    .muted{ color:var(--muted); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .field{
      display:flex; flex-direction:column; gap:6px;
      min-width: 150px;
      flex:1;
    }
    label{ font-size:12px; color:var(--muted); font-weight:700; }
    input, select{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.95);
      outline:none;
      font-family:inherit;
      font-weight:700;
    }
    input:focus, select:focus{
      border-color: rgba(91,140,255,.55);
      box-shadow: 0 0 0 4px rgba(91,140,255,.15);
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:14px;
      background: rgba(91,140,255,.10);
      border:1px solid rgba(91,140,255,.25);
      font-weight:800;
    }

    .terms{
      display:grid; grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width:520px){ .terms{ grid-template-columns: 1fr; } }

    .term{
      padding:12px;
      border-radius:16px;
      border:1px dashed rgba(17,24,39,.18);
      background: rgba(255,255,255,.7);
    }
    .term strong{ display:block; margin-bottom:4px; }
    .term .ex{ font-size:12px; color:var(--muted); }

    .eq{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px;
      border-radius:16px;
      background: rgba(34,197,94,.08);
      border:1px solid rgba(34,197,94,.22);
      margin-top:10px;
      font-weight:900;
      flex-wrap:wrap;
    }
    .eq .big{ font-size:18px; }
    .hint{
      margin-top:10px;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(245,158,11,.10);
      border:1px solid rgba(245,158,11,.22);
      font-weight:700;
      line-height:1.7;
    }

    .buckets{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .bucket{
      border-radius:18px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.75);
      padding:10px;
      min-height:120px;
      position:relative;
      overflow:hidden;
    }
    .bucketHead{
      display:flex; justify-content:space-between; align-items:center;
      gap:8px;
      margin-bottom:8px;
    }
    .bucketTitle{
      font-weight:900; font-size:13px;
      display:flex; align-items:center; gap:6px;
    }
    .countBadge{
      font-weight:900; font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(91,140,255,.10);
      border:1px solid rgba(91,140,255,.22);
    }
    .dropzone{
      min-height:80px;
      border-radius:14px;
      border:1px dashed rgba(17,24,39,.22);
      padding:8px;
      display:flex; flex-wrap:wrap; gap:6px;
      align-content:flex-start;
    }
    .dropzone.dragover{
      border-color: rgba(91,140,255,.70);
      background: rgba(91,140,255,.08);
    }

    .itemsTray{
      border-radius:18px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.75);
      padding:10px;
    }
    .trayHead{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      margin-bottom:8px;
    }
    .items{
      min-height:76px;
      border-radius:14px;
      border:1px dashed rgba(17,24,39,.22);
      padding:8px;
      display:flex; flex-wrap:wrap; gap:6px;
      align-content:flex-start;
    }
    .item{
      width:34px; height:34px;
      border-radius:12px;
      border:1px solid rgba(17,24,39,.12);
      background: rgba(255,255,255,.95);
      display:grid; place-items:center;
      cursor:grab;
      user-select:none;
      font-size:18px;
      box-shadow: 0 6px 14px rgba(16,24,40,.06);
    }
    .item:active{ cursor:grabbing; transform: scale(.98); }

    .feedback{
      margin-top:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.75);
      line-height:1.8;
      font-weight:700;
    }
    .feedback.good{ border-color: rgba(34,197,94,.28); background: rgba(34,197,94,.10); }
    .feedback.bad{ border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.08); }

    .quizBox{
      margin-top:10px;
      padding:12px;
      border-radius:18px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.75);
    }
    .qTop{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .qText{
      font-weight:900;
      font-size:16px;
      line-height:1.7;
    }
    .options{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
      margin-top:10px;
    }
    @media (max-width:520px){ .options{ grid-template-columns: 1fr; } }
    .opt{
      padding:12px;
      border-radius:16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.95);
      cursor:pointer;
      font-weight:900;
      font-size:16px;
      transition:.15s transform;
    }
    .opt:hover{ transform: translateY(-1px); }
    .opt.correct{ background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.30); }
    .opt.wrong{ background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.28); }

    .progress{
      height:10px; width:100%;
      background: rgba(17,24,39,.08);
      border-radius:999px;
      overflow:hidden;
      border:1px solid var(--border);
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(245,158,11,.95), rgba(34,197,94,.95));
      border-radius:999px;
      transition: width .25s ease;
    }

    .hidden{ display:none !important; }

    /* Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø·Ø±Ø­ Ø§Ù„Ù…ØªÙƒØ±Ø± */
    .stepsBox{
      margin-top:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.75);
    }
    .steps{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:8px;
      max-height: 220px;
      overflow:auto;
      padding-left:4px;
    }
    .stepLine{
      padding:8px 10px;
      border-radius:12px;
      border:1px dashed rgba(17,24,39,.18);
      background: rgba(255,255,255,.88);
      font-weight:900;
      font-size:13px;
      line-height:1.7;
    }

    footer{
      position:fixed;
      left:0; right:0; bottom:0;
      background: rgba(255,255,255,.85);
      border-top:1px solid var(--border);
      backdrop-filter: blur(10px);
      padding:10px 14px;
      font-size:12px;
      color:var(--muted);
      display:flex; justify-content:center;
      z-index:60;
    }

    /* Print */
    @media print{
      header, nav, footer, .noPrint{ display:none !important; }
      body{ background:#fff !important; }
      .wrap{ padding:0 !important; max-width:100% !important; }
      .card{ box-shadow:none !important; border:1px solid #ddd !important; background:#fff !important; }
      #printArea{ display:block !important; }
    }
    #printArea{ display:none; }
    .cert{
      padding:18px;
      border:2px solid #111;
      border-radius:16px;
    }
    .certHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    .certHead img{
      width:72px; height:72px;
      border-radius:16px;
      border:1px solid #ddd;
      object-fit:cover;
      background:#fff;
    }
    .cert h2{ font-size:22px; margin:0; }
    .cert .line{ margin:8px 0; font-size:16px; font-weight:700; }
    .cert .sig{ margin-top:16px; font-size:14px; color:#111; }

    .toast{
      position:fixed; top:16px; left:16px;
      background: rgba(17,24,39,.92);
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      font-weight:800;
      box-shadow: 0 20px 40px rgba(0,0,0,.25);
      opacity:0;
      transform: translateY(-10px);
      transition:.2s;
      z-index:1000;
      max-width: 360px;
    }
    .toast.show{
      opacity:1;
      transform: translateY(0);
    }
  </style>
</head>

<body>
  <div class="toast" id="toast"></div>

  <div class="wrap">
    <header>
      <div class="topActions">
        <span class="chip"><span>â­ Ù†Ø¬ÙˆÙ…ÙŠ:</span> <span class="stars" id="starsChip">Ù </span></span>
        <button class="btn good noPrint" id="btnSpeak">ğŸ”Š Ø§Ù‚Ø±Ø£ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª</button>
        <button class="btn primary noPrint" id="btnPrint">ğŸ–¨ï¸ Ø´Ù‡Ø§Ø¯Ø©/Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>

      <div class="brand">
        <div class="logo" title="Ø§Ù„Ø´Ø¹Ø§Ø± (Ø«Ø§Ø¨Øª)">
          <img src="logo.png" alt="logo"
               onerror="this.style.display='none'; document.getElementById('logoFallback').style.display='grid';">
          <span class="fallback" id="logoFallback">Ã·</span>
        </div>
        <div class="titleBlock">
          <h1>Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù‚Ø³Ù…Ø© Ù„Ù„Ø£Ø·ÙØ§Ù„</h1>
          <p>ØªØ·Ø¨ÙŠÙ‚ ØªÙØ§Ø¹Ù„ÙŠ Ù„ÙÙ‡Ù… Ø§Ù„Ù‚Ø³Ù…Ø©: ØªÙˆØ²ÙŠØ¹ â€¢ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª â€¢ Ø·Ø±Ø­ Ù…ØªÙƒØ±Ø± â€¢ ØªØ¯Ø±ÙŠØ¨ â€¢ Ø¥Ù†Ø¬Ø§Ø² â­</p>
        </div>
      </div>
    </header>

    <nav class="noPrint">
      <button class="tab active" data-tab="learn">ğŸ“˜ Ø§ÙÙ‡Ù… Ø§Ù„Ù‚Ø³Ù…Ø©</button>
      <button class="tab" data-tab="play">ğŸ§© Ù…Ù„Ø¹Ø¨ Ø§Ù„Ù‚Ø³Ù…Ø©</button>
      <button class="tab" data-tab="quiz">ğŸ¯ ØªØ¯Ø±Ù‘Ø¨</button>
      <button class="tab" data-tab="my">ğŸ… Ø¥Ù†Ø¬Ø§Ø²ÙŠ</button>
    </nav>

    <main>
      <!-- TAB: LEARN -->
      <section id="tab-learn">
        <div class="grid">
          <div class="card">
            <h2>Ø§Ù„ÙÙƒØ±Ø© Ø¨Ø¨Ø³Ø§Ø·Ø©</h2>
            <p class="muted" style="margin-top:0; line-height:1.8">
              Ø§Ù„Ù‚Ø³Ù…Ø© ØªØ¹Ù†ÙŠ: <b>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø´ÙŠØ§Ø¡ Ø¨Ø§Ù„ØªØ³Ø§ÙˆÙŠ</b> Ø£Ùˆ <b>ØªÙƒÙˆÙŠÙ† Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…ØªØ³Ø§ÙˆÙŠØ©</b>.
              Ø³Ù†ÙÙ‡Ù…Ù‡Ø§ Ø¨Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø«Ù… Ù†Ø¬Ø±Ø¨Ù‡Ø§ Ø¨Ø§Ù„Ù„Ø¹Ø¨ âœ¨
            </p>

            <div class="terms">
              <div class="term">
                <strong>Ø§Ù„Ù…Ù‚Ø³ÙˆÙ…</strong>
                <div class="ex">Ù‡Ùˆ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´ÙŠØ§Ø¡ ÙƒÙ„Ù‡Ø§ (Ù…Ø«Ù„: Ù¢Ù¤ ğŸ¬)</div>
              </div>
              <div class="term">
                <strong>Ø§Ù„Ù…Ù‚Ø³ÙˆÙ… Ø¹Ù„ÙŠÙ‡</strong>
                <div class="ex">Ù‡Ùˆ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª/Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø£Ùˆ Ø­Ø¬Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Ù…Ø«Ù„: Ù¦)</div>
              </div>
              <div class="term">
                <strong>Ù†Ø§ØªØ¬ Ø§Ù„Ù‚Ø³Ù…Ø©</strong>
                <div class="ex">ÙƒÙ… Ù„ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø©ØŸ Ø£Ùˆ ÙƒÙ… Ù…Ø¬Ù…ÙˆØ¹Ø©ØŸ</div>
              </div>
              <div class="term">
                <strong>Ø§Ù„Ø¨Ø§Ù‚ÙŠ</strong>
                <div class="ex">Ø£Ø´ÙŠØ§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙˆØ²ÙŠØ¹Ù‡Ø§ Ø¨Ø§Ù„ØªØ³Ø§ÙˆÙŠ (Ø¥Ù† ÙˆÙØ¬Ø¯)</div>
              </div>
            </div>

            <div class="hint">
              âœ¨ ØªØ°ÙƒÙ‘Ø±/ÙŠ: <b>Ø§Ù„Ù‚Ø³Ù…Ø© Ø¹ÙƒØ³ Ø§Ù„Ø¶Ø±Ø¨</b>  
              Ø¥Ø°Ø§ ÙƒØ§Ù†: Ù¢Ù¤ Ã· Ù¦ = Ù¤  
              Ø¥Ø°Ù†: Ù¦ Ã— Ù¤ = Ù¢Ù¤ âœ…
            </div>

            <div class="hint" style="background:rgba(91,140,255,.08); border-color:rgba(91,140,255,.22)">
              ğŸ§® <b>Ø§Ù„Ù‚Ø³Ù…Ø© Ø¨Ø§Ù„Ø·Ø±Ø­ Ø§Ù„Ù…ØªÙƒØ±Ø±</b> ØªØ¹Ù†ÙŠ: Ù†Ø·Ø±Ø­ Ø§Ù„Ù…Ù‚Ø³ÙˆÙ… Ø¹Ù„ÙŠÙ‡ Ù…Ù† Ø§Ù„Ù…Ù‚Ø³ÙˆÙ… Ù…Ø±Ø§Ø±Ù‹Ø§ØŒ
              ÙˆØ¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø·Ø±Ø­ = <b>Ø§Ù„Ù†Ø§ØªØ¬</b>ØŒ ÙˆÙ…Ø§ ÙŠØªØ¨Ù‚Ù‰ = <b>Ø§Ù„Ø¨Ø§Ù‚ÙŠ</b>.
            </div>
          </div>

          <div class="card">
            <h2>Ø¬Ø±Ù‘Ø¨/ÙŠ Ù…Ø«Ø§Ù„ Ø³Ø±ÙŠØ¹</h2>
            <div class="row">
              <div class="field">
                <label>Ø§Ù„Ù…Ù‚Ø³ÙˆÙ… (Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´ÙŠØ§Ø¡)</label>
                <input id="learnA" type="number" min="0" max="200" value="24">
              </div>
              <div class="field">
                <label>Ø§Ù„Ù…Ù‚Ø³ÙˆÙ… Ø¹Ù„ÙŠÙ‡</label>
                <input id="learnB" type="number" min="1" max="20" value="6">
              </div>
              <div class="field" style="min-width:220px; flex:1.4">
                <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø´Ø±Ø­</label>
                <select id="learnMode">
                  <option value="both" selected>ØªÙˆØ²ÙŠØ¹ + Ø·Ø±Ø­ Ù…ØªÙƒØ±Ø±</option>
                  <option value="share">ØªÙˆØ²ÙŠØ¹ Ø¨Ø§Ù„ØªØ³Ø§ÙˆÙŠ</option>
                  <option value="subtract">Ø·Ø±Ø­ Ù…ØªÙƒØ±Ø±</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <button class="btn primary" id="btnExplain">âœ¨ Ø§Ø´Ø±Ø­</button>
              <button class="btn" id="btnCheckMul">ğŸ” ØªØ­Ù‚Ù‚ Ø¨Ø§Ù„Ø¶Ø±Ø¨</button>
              <button class="btn warn" id="btnSubSteps">ğŸ§® Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø·Ø±Ø­ Ø§Ù„Ù…ØªÙƒØ±Ø±</button>
            </div>

            <div class="eq" id="learnEq">
              <span class="big" id="learnEqText">Ù¢Ù¤ Ã· Ù¦ = Ù¤ ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ Ù </span>
              <span class="pill" id="learnPill">ØªÙˆØ²ÙŠØ¹ + Ø·Ø±Ø­</span>
            </div>

            <div class="feedback" id="learnExplain">
              Ø§Ø¶ØºØ·/ÙŠ <b>Ø§Ø´Ø±Ø­</b> Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø£Ø·ÙØ§Ù„.
            </div>

            <div class="stepsBox" id="subStepsBox">
              <div style="font-weight:900">ğŸ§® Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø·Ø±Ø­ Ø§Ù„Ù…ØªÙƒØ±Ø± (ØªÙØ­Ø¯Ù‘Ø« Ø­Ø³Ø¨ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…)</div>
              <div class="muted" id="subStepsSummary" style="margin-top:4px">
                Ø§Ø¶ØºØ·/ÙŠ Ø²Ø± <b>Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø·Ø±Ø­ Ø§Ù„Ù…ØªÙƒØ±Ø±</b> Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·ÙˆØ§Øª.
              </div>
              <div class="steps" id="subStepsList"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- TAB: PLAY -->
      <section id="tab-play" class="hidden">
        <div class="grid">
          <div class="card">
            <h2>Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
            <div class="row">
              <div class="field">
                <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù„Ø¹Ø¨</label>
                <select id="playType">
                  <option value="share">ØªÙˆØ²ÙŠØ¹ Ø¨Ø§Ù„ØªØ³Ø§ÙˆÙŠ (ÙƒÙ… Ù„ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø©ØŸ)</option>
                  <option value="group">ØªÙƒÙˆÙŠÙ† Ù…Ø¬Ù…ÙˆØ¹Ø§Øª (ÙƒÙ… Ù…Ø¬Ù…ÙˆØ¹Ø©ØŸ)</option>
                </select>
              </div>
              <div class="field">
                <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± (Ø§Ù„Ù…Ù‚Ø³ÙˆÙ…) â€” Ø£Ù‚ØµÙ‰ Ù¦Ù </label>
                <input id="playA" type="number" min="0" max="60" value="24">
              </div>
              <div class="field">
                <label id="playBLabel">Ø§Ù„Ù…Ù‚Ø³ÙˆÙ… Ø¹Ù„ÙŠÙ‡</label>
                <input id="playB" type="number" min="1" max="12" value="6">
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <button class="btn primary" id="btnStartPlay">ğŸš€ Ø§Ø¨Ø¯Ø£</button>
              <button class="btn" id="btnAutoDistribute">ğŸ¤– ÙˆØ²Ù‘Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</button>
              <button class="btn good" id="btnCheckPlay">âœ… ØªØ­Ù‚Ù‚</button>
              <button class="btn bad" id="btnResetPlay">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø©</button>
            </div>

            <div class="hint" style="margin-top:10px">
              ğŸ‘‡ Ø§Ø³Ø­Ø¨/ÙŠ ğŸ¬ Ù…Ù† Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª.  
              Ø§Ù„Ù‡Ø¯Ù: <b>ØªØ³Ø§ÙˆÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</b> Ø£Ùˆ <b>ØªØ³Ø§ÙˆÙŠ Ø­Ø¬Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</b> Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù„Ø¹Ø¨.
            </div>

            <div class="eq" id="playEq">
              <span class="big" id="playEqText">â€”</span>
              <span class="pill" id="playEqPill">Ù…Ù„Ø¹Ø¨ Ø§Ù„Ù‚Ø³Ù…Ø©</span>
            </div>

            <div class="feedback" id="playFeedback">
              Ø§Ø¶ØºØ·/ÙŠ <b>Ø§Ø¨Ø¯Ø£</b> Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨.
            </div>
          </div>

          <div class="card">
            <h2>Ø§Ù„Ù…Ù„Ø¹Ø¨</h2>

            <div class="itemsTray">
              <div class="trayHead">
                <div class="bucketTitle">ğŸ’ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù†Ø§ØµØ±</div>
                <span class="countBadge">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span id="trayCount">Ù </span></span>
              </div>
              <div class="items dropzone" id="tray" aria-label="ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù†Ø§ØµØ±"></div>
            </div>

            <div class="buckets" id="buckets"></div>
          </div>
        </div>
      </section>

      <!-- TAB: QUIZ -->
      <section id="tab-quiz" class="hidden">
        <div class="grid">
          <div class="card">
            <h2>Ø§Ø®ØªØ±/ÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙ‰</h2>
            <div class="row">
              <div class="field">
                <label>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</label>
                <select id="level">
                  <option value="easy">Ø³Ù‡Ù„ (Ù¢ØŒÙ¥ØŒÙ¡Ù )</option>
                  <option value="mid">Ù…ØªÙˆØ³Ø· (Ù£ØŒÙ¤ØŒÙ¦ØŒÙ¨)</option>
                  <option value="hard">Ù…ØªÙ‚Ø¯Ù… (Ù§â€“Ù¡Ù¢ + Ø¨ÙˆØ§Ù‚ÙŠ)</option>
                </select>
              </div>
              <div class="field">
                <label>Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</label>
                <select id="qType">
                  <option value="mix">Ù…ØªÙ†ÙˆØ¹</option>
                  <option value="fact">Ù…Ø¨Ø§Ø´Ø± (Ã·)</option>
                  <option value="word">Ù…Ø³Ø£Ù„Ø© Ù„ÙØ¸ÙŠØ©</option>
                  <option value="remainder">Ù…Ø¹ Ø§Ù„Ø¨Ø§Ù‚ÙŠ</option>
                </select>
              </div>
              <div class="field">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¹Ù„Ù…/Ø© (Ù„Ù„Ø´Ù‡Ø§Ø¯Ø©)</label>
                <input id="studentName" type="text" placeholder="Ù…Ø«Ø§Ù„: Ù†ÙˆØ± Ø£Ùˆ Ø±Ø§Ø´Ø¯">
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <button class="btn primary" id="btnNewQ">ğŸ² Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯</button>
              <button class="btn good" id="btnHint">ğŸ’¡ ØªÙ„Ù…ÙŠØ­</button>
              <button class="btn" id="btnReadQ">ğŸ”Š Ø§Ù‚Ø±Ø£ Ø§Ù„Ø³Ø¤Ø§Ù„</button>
            </div>

            <div class="quizBox" id="quizBox">
              <div class="qTop">
                <div class="pill">ğŸ“Œ Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="score">Ù </span></div>
                <div class="pill">ğŸ”¥ Ø³Ù„Ø³Ù„Ø© ØµØ­ÙŠØ­Ø©: <span id="streak">Ù </span></div>
              </div>
              <div class="progress"><div class="bar" id="starBar"></div></div>

              <div class="qText" id="qText" style="margin-top:10px">Ø§Ø¶ØºØ·/ÙŠ <b>Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯</b> Ù„Ù„Ø¨Ø¯Ø¡.</div>
              <div class="options" id="options"></div>

              <div class="feedback" id="qFeedback">Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø³ÙŠØªÙ… Ø´Ø±Ø­ Ø§Ù„Ø­Ù„ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ© âœ¨</div>
            </div>
          </div>

          <div class="card">
            <h2>ÙƒÙŠÙ Ø£ÙÙƒØ±ØŸ (Ø®Ø·ÙˆØ§Øª Ø°ÙƒÙŠØ©)</h2>
            <div class="term">
              <strong>Ù¡) Ø§Ù‚Ø±Ø£ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</strong>
              <div class="ex">Ù‡Ù„ ÙŠØ±ÙŠØ¯: ÙƒÙ… Ù„ÙƒÙ„ ÙˆØ§Ø­Ø¯ØŸ Ø£Ù… ÙƒÙ… Ù…Ø¬Ù…ÙˆØ¹Ø©ØŸ</div>
            </div>
            <div class="term" style="margin-top:10px">
              <strong>Ù¢) Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¶Ø±Ø¨ Ù„Ù„ØªØ­Ù‚Ù‚</strong>
              <div class="ex">Ø§Ù„Ù…Ù‚Ø³ÙˆÙ… Ø¹Ù„ÙŠÙ‡ Ã— Ø§Ù„Ù†Ø§ØªØ¬ = Ø§Ù„Ù…Ù‚Ø³ÙˆÙ… (Ø£Ùˆ Ø£Ù‚Ù„ Ù…Ù†Ù‡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¨Ø§Ù‚ÙŠ)</div>
            </div>
            <div class="term" style="margin-top:10px">
              <strong>Ù£) Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø·Ø±Ø­ Ø§Ù„Ù…ØªÙƒØ±Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©</strong>
              <div class="ex">Ø§Ø·Ø±Ø­ Ø§Ù„Ù…Ù‚Ø³ÙˆÙ… Ø¹Ù„ÙŠÙ‡ Ù…Ø±Ø§Ø±Ù‹Ø§ Ø­ØªÙ‰ Ù„Ø§ ØªØ³ØªØ·ÙŠØ¹ Ø§Ù„Ø·Ø±Ø­. Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø·Ø±Ø­ = Ø§Ù„Ù†Ø§ØªØ¬.</div>
            </div>
            <div class="hint" style="margin-top:12px">
              â­ ÙƒÙ„ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© = Ù†Ø¬Ù…Ø©  
              â­ Ø¹Ù†Ø¯ Ø¬Ù…Ø¹ Ù†Ø¬ÙˆÙ… ÙƒØ§ÙÙŠØ© ÙŠÙ…ÙƒÙ† Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù…Ù† Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©.
            </div>
          </div>
        </div>
      </section>

      <!-- TAB: MY -->
      <section id="tab-my" class="hidden">
        <div class="grid">
          <div class="card">
            <h2>Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</h2>
            <div class="row">
              <span class="pill">â­ Ø§Ù„Ù†Ø¬ÙˆÙ…: <span id="myStars">Ù </span></span>
              <span class="pill">ğŸ¯ Ø£Ø³Ø¦Ù„Ø© Ù…Ø­Ù„ÙˆÙ„Ø©: <span id="mySolved">Ù </span></span>
              <span class="pill">ğŸ† Ø£ÙØ¶Ù„ Ø³Ù„Ø³Ù„Ø©: <span id="myBest">Ù </span></span>
            </div>

            <div class="hint" style="margin-top:10px">
              ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù… ÙƒÙ…Ù„Ù JSON Ø£Ùˆ Ø·Ø¨Ø§Ø¹ØªÙ‡ ÙƒØ´Ù‡Ø§Ø¯Ø©.
            </div>

            <div class="row noPrint" style="margin-top:10px">
              <button class="btn primary" id="btnExport">â¬‡ï¸ ØªØµØ¯ÙŠØ± JSON</button>
              <button class="btn" id="btnImport">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
              <button class="btn warn" id="btnResetAll">ğŸ§¹ ØªØµÙÙŠØ± Ø§Ù„ØªÙ‚Ø¯Ù…</button>
            </div>
            <input type="file" id="importInput" accept="application/json" class="hidden">

            <div class="card" style="margin-top:12px; background:rgba(255,255,255,.72)">
              <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</h3>
              <div class="row">
                <div class="field">
                  <label>Ø§Ù„ØµÙ/Ø§Ù„ÙØµÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                  <input id="className" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø«Ø§Ù„Ø«/Ù¡">
                </div>
                <div class="field">
                  <label>Ù…Ù„Ø§Ø­Ø¸Ø© Ù‚ØµÙŠØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                  <input id="note" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø¯Ø§Ø¡ Ø±Ø§Ø¦Ø¹ ÙÙŠ Ø§Ù„Ù‚Ø³Ù…Ø©!">
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <h2>Ø£Ù‡Ø¯Ø§Ù ØµØºÙŠØ±Ø© ØªØ³Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ¹Ù„Ù…/Ø©</h2>
            <div class="term">
              <strong>ğŸ¯ Ù‡Ø¯Ù Ø§Ù„ÙŠÙˆÙ…</strong>
              <div class="ex">Ø­Ù„ Ù¥ Ø£Ø³Ø¦Ù„Ø© + ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ù„Ø¹Ø¨ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©.</div>
            </div>
            <div class="term" style="margin-top:10px">
              <strong>ğŸ§© Ù‡Ø¯Ù Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</strong>
              <div class="ex">Ø¥ØªÙ‚Ø§Ù† Ø§Ù„Ù‚Ø³Ù…Ø© Ø¹Ù„Ù‰ Ù¢ ÙˆÙ¥ ÙˆÙ¡Ù  Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø§Ù„Ø¶Ø±Ø¨.</div>
            </div>
            <div class="term" style="margin-top:10px">
              <strong>ğŸ’ª ØªØ­Ø¯ÙŠ Ø§Ù„Ø¨Ø§Ù‚ÙŠ</strong>
              <div class="ex">ÙÙ‡Ù… Ù…Ø¹Ù†Ù‰ Ø§Ù„Ø¨Ø§Ù‚ÙŠ ÙˆÙ„Ù…Ø§Ø°Ø§ Ù‡Ùˆ Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ù‚Ø³ÙˆÙ… Ø¹Ù„ÙŠÙ‡.</div>
            </div>

            <div class="hint" style="margin-top:12px">
              ğŸ‘©â€ğŸ«ğŸ‘¨â€ğŸ« Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ù…Ø¹Ù„Ù…/Ø©: Ø§ØªØ±Ùƒ/ÙŠ Ø§Ù„Ù…ØªØ¹Ù„Ù…/Ø© ÙŠØ¬Ø±Ù‘Ø¨/ØªØ¬Ø±Ù‘Ø¨ Ø£ÙˆÙ„Ù‹Ø§ Ø«Ù… Ù†Ø§Ù‚Ø´/ÙŠ:
              â€œÙƒÙŠÙ Ø¹Ø±ÙØª Ø§Ù„Ù†Ø§ØªØ¬ØŸ Ù…Ø§Ø°Ø§ Ø­Ø¯Ø« Ù„Ù„Ø¨Ø§Ù‚ÙŠØŸâ€
            </div>
          </div>
        </div>
      </section>

      <!-- PRINT AREA -->
      <section id="printArea">
        <div class="card">
          <div class="cert">
            <div class="certHead">
              <img src="logo.png" alt="logo" onerror="this.style.display='none'">
              <h2>Ø´Ù‡Ø§Ø¯Ø© Ø¥Ù†Ø¬Ø§Ø² â€” Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù‚Ø³Ù…Ø©</h2>
            </div>

            <div class="line">Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¹Ù„Ù…/Ø©: <span id="pName">â€”</span></div>
            <div class="line">Ø§Ù„ØµÙ/Ø§Ù„ÙØµÙ„: <span id="pClass">â€”</span></div>
            <div class="line">Ø§Ù„Ù†Ø¬ÙˆÙ…: <span id="pStars">â€”</span></div>
            <div class="line">Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø©: <span id="pSolved">â€”</span></div>
            <div class="line">Ø§Ù„ØªØ§Ø±ÙŠØ®: <span id="pDate">â€”</span></div>
            <div class="line">Ù…Ù„Ø§Ø­Ø¸Ø©: <span id="pNote">â€”</span></div>

            <div class="sig">
              ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…/Ø©: ______________________
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- âœ… Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø¨Ø¯ÙˆÙ† ÙƒÙ„Ù…Ø© "ØªØ°ÙŠÙŠÙ„ Ø«Ø§Ø¨Øª" -->
  <footer>
    <span>Â© Ø£/ ÙØ§Ø·Ù…Ø© Ù‡Ø²Ø§Ø²ÙŠ ØŒ Ù…Ù„ØªÙ‚Ù‰ Ù…Ø¹Ù„Ù…ÙŠ ÙˆÙ…Ø¹Ù„Ù…Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª ØŒ Ù…Ù„ØªÙ‚Ù‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ</span>
  </footer>

<script>
/* =========================
   Helpers
========================= */
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));
function clearNode(node){ while(node.firstChild) node.removeChild(node.firstChild); }

const AR_DIGITS = ["Ù ","Ù¡","Ù¢","Ù£","Ù¤","Ù¥","Ù¦","Ù§","Ù¨","Ù©"];
function toArabicDigits(val){
  const str = String(val);
  return str.replace(/\d/g, d => AR_DIGITS[Number(d)]);
}
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

function toast(msg){
  const t = $("#toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 2100);
}

/* =========================
   Persistence
========================= */
const KEY = "divisionHelperProgress_v3";
function defaultProgress(){
  return {
    stars:0,
    score:0,
    solved:0,
    bestStreak:0,
    lastStudent:"",
    lastClass:"",
    note:""
  };
}
function loadProgress(){
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw) return defaultProgress();
    const p = JSON.parse(raw);
    return { ...defaultProgress(), ...p };
  }catch(e){
    return defaultProgress();
  }
}
function saveProgress(){
  localStorage.setItem(KEY, JSON.stringify(progress));
  syncProgressUI();
}
let progress = loadProgress();

/* =========================
   Tabs
========================= */
function showTab(tab){
  $$(".tab").forEach(b=>b.classList.toggle("active", b.dataset.tab===tab));
  $("#tab-learn").classList.toggle("hidden", tab!=="learn");
  $("#tab-play").classList.toggle("hidden", tab!=="play");
  $("#tab-quiz").classList.toggle("hidden", tab!=="quiz");
  $("#tab-my").classList.toggle("hidden", tab!=="my");
  window.scrollTo({top:0, behavior:"smooth"});
}
$$(".tab").forEach(b=>b.addEventListener("click", ()=>showTab(b.dataset.tab)));

/* =========================
   Speech (Arabic)
========================= */
function speak(text){
  if(!("speechSynthesis" in window)) return toast("Ù…ÙŠØ²Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­.");
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "ar-SA";
  u.rate = 1.0;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}
$("#btnSpeak").addEventListener("click", ()=>{
  speak("Ù…Ø±Ø­Ø¨Ù‹Ø§! Ù‡Ø°Ø§ Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù‚Ø³Ù…Ø©. Ø§Ø¨Ø¯Ø£ Ø¨ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ø§ÙÙ‡Ù… Ø§Ù„Ù‚Ø³Ù…Ø©ØŒ Ø«Ù… Ø¬Ø±Ù‘Ø¨ Ù…Ù„Ø¹Ø¨ Ø§Ù„Ù‚Ø³Ù…Ø©ØŒ ÙˆØ¨Ø¹Ø¯Ù‡Ø§ Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„Ù‰ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ù„ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ù†Ø¬ÙˆÙ… ÙˆØ´Ù‡Ø§Ø¯Ø©.");
});

/* =========================
   Division helpers
========================= */
function computeDivision(a,b){
  if(b<=0) return {q:0, r:a};
  const q = Math.floor(a/b);
  const r = a - q*b;
  return {q,r};
}
function buildSubtractionSteps(a,b,limit=18){
  const {q,r} = computeDivision(a,b);
  let cur = a;
  const n = Math.min(q, limit);
  const lines = [];
  for(let i=1; i<=n; i++){
    const next = cur - b;
    lines.push({i, cur, next});
    cur = next;
  }
  const truncated = q > limit;
  return {q,r, lines, truncated};
}
function renderSubStepsBox(a,b){
  const {q,r, lines, truncated} = buildSubtractionSteps(a,b,18);
  $("#subStepsSummary").innerHTML =
    `Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø·Ø±Ø­ = <b>${toArabicDigits(q)}</b>ØŒ ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ = <b>${toArabicDigits(r)}</b>.`;
  const list = $("#subStepsList");
  clearNode(list);

  if(b<=0){
    const d = document.createElement("div");
    d.className="stepLine";
    d.textContent = "Ø£Ø¯Ø®Ù„/ÙŠ Ù…Ù‚Ø³ÙˆÙ… Ø¹Ù„ÙŠÙ‡ ØµØ­ÙŠØ­.";
    list.appendChild(d);
    return;
  }

  if(q===0){
    const d = document.createElement("div");
    d.className="stepLine";
    d.textContent = `Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø·Ø±Ø­ ${toArabicDigits(b)} Ù…Ù† ${toArabicDigits(a)} Ø­ØªÙ‰ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©ØŒ Ø¥Ø°Ù† Ø§Ù„Ù†Ø§ØªØ¬ Ù  ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ ${toArabicDigits(a)}.`;
    list.appendChild(d);
    return;
  }

  lines.forEach(s=>{
    const d = document.createElement("div");
    d.className="stepLine";
    d.textContent = `Ø§Ù„Ø®Ø·ÙˆØ© ${toArabicDigits(s.i)}: ${toArabicDigits(s.cur)} âˆ’ ${toArabicDigits(b)} = ${toArabicDigits(s.next)}`;
    list.appendChild(d);
  });

  if(truncated){
    const d = document.createElement("div");
    d.className="stepLine";
    d.textContent = "â€¦ ØªÙ… Ø§Ø®ØªØµØ§Ø± Ø§Ù„Ø®Ø·ÙˆØ§Øª (Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙƒØ¨ÙŠØ±Ø©).";
    list.appendChild(d);
  }

  const last = document.createElement("div");
  last.className="stepLine";
  last.textContent = `âœ… Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${toArabicDigits(a)} Ã· ${toArabicDigits(b)} = ${toArabicDigits(q)} ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ ${toArabicDigits(r)}.`;
  list.appendChild(last);
}

function buildSubBoxHtml(a,b){
  const {q,r, lines, truncated} = buildSubtractionSteps(a,b,10);
  const items = lines.map(s =>
    `<div class="stepLine">Ø§Ù„Ø®Ø·ÙˆØ© ${toArabicDigits(s.i)}: ${toArabicDigits(s.cur)} âˆ’ ${toArabicDigits(b)} = ${toArabicDigits(s.next)}</div>`
  ).join("");
  const more = truncated ? `<div class="stepLine">â€¦ ØªÙ… Ø§Ø®ØªØµØ§Ø± Ø¨Ù‚ÙŠØ© Ø§Ù„Ø®Ø·ÙˆØ§Øª</div>` : "";
  return `
    <div class="stepsBox">
      <div style="font-weight:900">ğŸ§® Ø§Ù„Ù‚Ø³Ù…Ø© Ø¨Ø§Ù„Ø·Ø±Ø­ Ø§Ù„Ù…ØªÙƒØ±Ø±</div>
      <div class="muted" style="margin-top:4px">
        Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø·Ø±Ø­ = <b>${toArabicDigits(q)}</b>ØŒ ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ = <b>${toArabicDigits(r)}</b>.
      </div>
      <div class="steps">${items}${more}</div>
    </div>
  `;
}

/* =========================
   LEARN
========================= */
function updateLearnEq(){
  const a = clamp(Number($("#learnA").value||0),0,9999);
  const b = clamp(Number($("#learnB").value||1),1,9999);
  const {q,r} = computeDivision(a,b);
  $("#learnEqText").textContent = `${toArabicDigits(a)} Ã· ${toArabicDigits(b)} = ${toArabicDigits(q)} ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ ${toArabicDigits(r)}`;
}
$("#learnA").addEventListener("input", ()=>{ updateLearnEq(); });
$("#learnB").addEventListener("input", ()=>{ updateLearnEq(); });

$("#btnExplain").addEventListener("click", ()=>{
  const a = clamp(Number($("#learnA").value||0),0,200);
  const b = clamp(Number($("#learnB").value||1),1,20);
  const mode = $("#learnMode").value;
  const {q,r} = computeDivision(a,b);

  const parts = [];
  $("#learnPill").textContent = (mode==="subtract") ? "Ø·Ø±Ø­ Ù…ØªÙƒØ±Ø±" : (mode==="share") ? "ØªÙˆØ²ÙŠØ¹" : "ØªÙˆØ²ÙŠØ¹ + Ø·Ø±Ø­";

  parts.push(`ğŸ”¹ Ù„Ø¯ÙŠÙ†Ø§ ${toArabicDigits(a)} Ø¹Ù†ØµØ±Ù‹Ø§ ÙˆÙ†Ù‚Ø³Ù…Ù‡Ø§ Ø¹Ù„Ù‰ ${toArabicDigits(b)}.`);
  parts.push(`ğŸ”¹ Ø§Ù„Ù‡Ø¯Ù: Ù…Ø¹Ø±ÙØ© Ø§Ù„Ù†Ø§ØªØ¬ ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ Ø¥Ù† ÙˆÙØ¬Ø¯.`);

  if(mode==="share" || mode==="both"){
    parts.push(`âœ… Ø¨Ø§Ù„ØªÙˆØ²ÙŠØ¹: Ø¥Ø°Ø§ ÙˆØ²Ù‘Ø¹Ù†Ø§ ${toArabicDigits(a)} Ø¨Ø§Ù„ØªØ³Ø§ÙˆÙŠ Ø¹Ù„Ù‰ ${toArabicDigits(b)} Ù…Ø¬Ù…ÙˆØ¹Ø§ØªØŒ ÙŠØµØ¨Ø­ ÙÙŠ ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø© ${toArabicDigits(q)}.`);
    parts.push(r>0 ? `ÙˆÙŠØ¨Ù‚Ù‰ ${toArabicDigits(r)} Ø¹Ù†ØµØ±Ù‹Ø§ (Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø¨Ø§Ù‚ÙŠ).` : `ÙˆÙ„Ø§ ÙŠØªØ¨Ù‚Ù‰ Ø´ÙŠØ¡ØŒ Ø¥Ø°Ù† Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ù .`);
  }

  if(mode==="subtract" || mode==="both"){
    parts.push(`âœ… Ø¨Ø§Ù„Ø·Ø±Ø­ Ø§Ù„Ù…ØªÙƒØ±Ø±: Ù†Ø·Ø±Ø­ ${toArabicDigits(b)} Ù…Ø±Ø© ØªÙ„Ùˆ Ø§Ù„Ø£Ø®Ø±Ù‰ Ø­ØªÙ‰ Ù„Ø§ Ù†Ø³ØªØ·ÙŠØ¹ Ø§Ù„Ø·Ø±Ø­.`);
    parts.push(`Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø·Ø±Ø­ = ${toArabicDigits(q)}ØŒ ÙˆØ§Ù„Ù…ØªØ¨Ù‚ÙŠ = ${toArabicDigits(r)}.`);
  }

  parts.push(`ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø§Ù„Ø¶Ø±Ø¨: ${toArabicDigits(b)} Ã— ${toArabicDigits(q)} + ${toArabicDigits(r)} = ${toArabicDigits(b*q + r)}.`);

  $("#learnExplain").innerHTML = parts.join("<br>");
  updateLearnEq();
  renderSubStepsBox(a,b);
});

$("#btnCheckMul").addEventListener("click", ()=>{
  const a = clamp(Number($("#learnA").value||0),0,200);
  const b = clamp(Number($("#learnB").value||1),1,20);
  const {q,r} = computeDivision(a,b);
  const check = b*q + r;
  const ok = (check===a);
  $("#learnExplain").classList.remove("good","bad");
  $("#learnExplain").classList.add(ok ? "good" : "bad");
  $("#learnExplain").innerHTML =
    ok
    ? `âœ… ØªØ­Ù‚Ù‚ ØµØ­ÙŠØ­: ${toArabicDigits(b)}Ã—${toArabicDigits(q)} + ${toArabicDigits(r)} = ${toArabicDigits(a)}`
    : `âš ï¸ ØªØ­Ù‚Ù‚ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚: Ø±Ø§Ø¬Ø¹/ÙŠ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø¯Ø®Ù„Ø©.`;
});

$("#btnSubSteps").addEventListener("click", ()=>{
  const a = clamp(Number($("#learnA").value||0),0,200);
  const b = clamp(Number($("#learnB").value||1),1,20);
  renderSubStepsBox(a,b);
  toast("ØªÙ… Ø¹Ø±Ø¶ Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø·Ø±Ø­ Ø§Ù„Ù…ØªÙƒØ±Ø± ğŸ§®");
});

/* =========================
   PLAY
========================= */
let playState = {
  type:"share",
  a:24,
  b:6,
  buckets:[],
  items:[],
  started:false
};

function makeItem(id){
  const el = document.createElement("div");
  el.className = "item";
  el.textContent = "ğŸ¬";
  el.draggable = true;
  el.dataset.id = String(id);
  el.addEventListener("dragstart", (e)=>{
    e.dataTransfer.setData("text/plain", String(id));
  });
  return el;
}

function attachDropHandlers(zone, onDrop){
  zone.addEventListener("dragover", (e)=>{ e.preventDefault(); zone.classList.add("dragover"); });
  zone.addEventListener("dragleave", ()=>zone.classList.remove("dragover"));
  zone.addEventListener("drop", (e)=>{
    e.preventDefault();
    zone.classList.remove("dragover");
    const id = e.dataTransfer.getData("text/plain");
    if(!id) return;
    onDrop(id, zone);
  });
}

function updatePlayEq(){
  if(!playState.started){
    $("#playEqText").textContent = "â€”";
    return;
  }
  const a = playState.a, b = playState.b;
  const {q,r} = computeDivision(a,b);

  if(playState.type==="share"){
    $("#playEqText").textContent = `${toArabicDigits(a)} Ã· ${toArabicDigits(b)} = ${toArabicDigits(q)} ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ ${toArabicDigits(r)}`;
    $("#playEqPill").textContent = "ØªÙˆØ²ÙŠØ¹ Ø¨Ø§Ù„ØªØ³Ø§ÙˆÙŠ";
  }else{
    $("#playEqText").textContent = `${toArabicDigits(a)} Ã· ${toArabicDigits(b)} = ${toArabicDigits(q)} Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ ${toArabicDigits(r)}`;
    $("#playEqPill").textContent = "ØªÙƒÙˆÙŠÙ† Ù…Ø¬Ù…ÙˆØ¹Ø§Øª";
  }
}

function updateBucketCounts(){
  $("#trayCount").textContent = toArabicDigits($("#tray").children.length);
  $$("#buckets .bucket").forEach(bucket=>{
    const dz = bucket.querySelector(".dropzone");
    const cnt = dz ? dz.children.length : 0;
    bucket.querySelector(".cnt").textContent = toArabicDigits(cnt);
  });
  updatePlayEq();
}

function setupPlay(){
  playState.type = $("#playType").value;
  playState.a = clamp(Number($("#playA").value||0),0,60);
  playState.b = clamp(Number($("#playB").value||1),1,12);
  playState.started = true;

  $("#playBLabel").textContent =
    playState.type==="share"
    ? "Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª/Ø§Ù„Ø£Ø´Ø®Ø§Øµ (Ø§Ù„Ù…Ù‚Ø³ÙˆÙ… Ø¹Ù„ÙŠÙ‡)"
    : "Ø­Ø¬Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Ø§Ù„Ù…Ù‚Ø³ÙˆÙ… Ø¹Ù„ÙŠÙ‡)";

  clearNode($("#tray"));
  clearNode($("#buckets"));

  playState.items = [];
  for(let i=1;i<=playState.a;i++){
    const it = makeItem(i);
    playState.items.push(it);
    $("#tray").appendChild(it);
  }

  const bucketsEl = $("#buckets");
  playState.buckets = [];

  let bucketCount = (playState.type==="share") ? playState.b : Math.max(1, Math.floor(playState.a / playState.b) + 1);
  bucketCount = clamp(bucketCount, 1, 12);

  for(let i=0;i<bucketCount;i++){
    const card = document.createElement("div");
    card.className = "bucket";
    const head = document.createElement("div");
    head.className = "bucketHead";

    const title = document.createElement("div");
    title.className = "bucketTitle";
    title.innerHTML = (playState.type==="share")
      ? `ğŸ‘¥ Ù…Ø¬Ù…ÙˆØ¹Ø© ${toArabicDigits(i+1)}`
      : `ğŸ“¦ Ù…Ø¬Ù…ÙˆØ¹Ø© ${toArabicDigits(i+1)}`;

    const badge = document.createElement("div");
    badge.className = "countBadge";
    badge.innerHTML = `Ø¯Ø§Ø®Ù„Ù‡Ø§: <span class="cnt">Ù </span>`;

    head.appendChild(title);
    head.appendChild(badge);

    const dz = document.createElement("div");
    dz.className = "dropzone";
    dz.dataset.bucket = String(i);

    attachDropHandlers(dz, (id)=>{
      const item = playState.items.find(x=>x.dataset.id===String(id));
      if(!item) return;
      dz.appendChild(item);
      updateBucketCounts();
    });

    card.appendChild(head);
    card.appendChild(dz);
    bucketsEl.appendChild(card);

    playState.buckets.push({dz, badge});
  }

  attachDropHandlers($("#tray"), (id)=>{
    const item = playState.items.find(x=>x.dataset.id===String(id));
    if(!item) return;
    $("#tray").appendChild(item);
    updateBucketCounts();
  });

  updateBucketCounts();
  updatePlayEq();
  $("#playFeedback").className = "feedback";
  $("#playFeedback").innerHTML = "Ø§Ø¨Ø¯Ø£/ÙŠ Ø¨ØªÙˆØ²ÙŠØ¹ ğŸ¬ Ø«Ù… Ø§Ø¶ØºØ·/ÙŠ <b>ØªØ­Ù‚Ù‚</b>.";
}

$("#playType").addEventListener("change", ()=>{
  $("#playBLabel").textContent =
    $("#playType").value==="share"
    ? "Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª/Ø§Ù„Ø£Ø´Ø®Ø§Øµ (Ø§Ù„Ù…Ù‚Ø³ÙˆÙ… Ø¹Ù„ÙŠÙ‡)"
    : "Ø­Ø¬Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Ø§Ù„Ù…Ù‚Ø³ÙˆÙ… Ø¹Ù„ÙŠÙ‡)";
});
$("#btnStartPlay").addEventListener("click", setupPlay);

$("#btnResetPlay").addEventListener("click", ()=>{
  playState.started = false;
  clearNode($("#tray"));
  clearNode($("#buckets"));
  $("#playFeedback").className = "feedback";
  $("#playFeedback").textContent = "Ø§Ø¶ØºØ·/ÙŠ Ø§Ø¨Ø¯Ø£ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨.";
  updatePlayEq();
});

$("#btnAutoDistribute").addEventListener("click", ()=>{
  if(!playState.started) return toast("Ø§Ø¨Ø¯Ø£/ÙŠ Ø£ÙˆÙ„Ù‹Ø§ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø¨Ø¯Ø£.");
  const a = playState.a, b = playState.b;

  const tray = $("#tray");
  playState.items.forEach(it=>tray.appendChild(it));

  const bucketZones = playState.buckets.map(x=>x.dz);
  if(bucketZones.length===0) return;

  if(playState.type==="share"){
    let idx = 0;
    playState.items.forEach(it=>{
      bucketZones[idx % b]?.appendChild(it);
      idx++;
    });
  }else{
    let k = 0;
    const fullGroups = Math.floor(a/b);
    for(let g=0; g<fullGroups; g++){
      for(let t=0; t<b; t++){
        const it = playState.items[k++];
        if(it && bucketZones[g]) bucketZones[g].appendChild(it);
      }
    }
  }

  updateBucketCounts();
  toast("ØªÙ… Ø§Ù„ØªÙˆØ²ÙŠØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ğŸ¤–");
});

$("#btnCheckPlay").addEventListener("click", ()=>{
  if(!playState.started) return toast("Ø§Ø¨Ø¯Ø£/ÙŠ Ø£ÙˆÙ„Ù‹Ø§ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø¨Ø¯Ø£.");

  const a = playState.a, b = playState.b;
  const {q,r} = computeDivision(a,b);

  const trayCount = $("#tray").children.length;
  let ok = false;
  let msg = "";

  if(playState.type==="share"){
    const allBuckets = $$("#buckets .dropzone").slice(0, b);
    const goodBuckets = allBuckets.every(z => z.children.length === q);
    ok = goodBuckets && (trayCount === r);
    msg = ok
      ? `âœ… ØªÙˆØ²ÙŠØ¹ ØµØ­ÙŠØ­: ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø© ÙÙŠÙ‡Ø§ ${toArabicDigits(q)} ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ ${toArabicDigits(r)}.`
      : `Ø¬Ø±Ù‘Ø¨/ÙŠ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰: Ø§Ù„Ù‡Ø¯Ù Ø£Ù† ØªÙƒÙˆÙ† ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø© ${toArabicDigits(q)} ÙˆØ£Ù† ÙŠØ¨Ù‚Ù‰ ${toArabicDigits(r)} ÙÙŠ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ (Ø§Ù„Ø¨Ø§Ù‚ÙŠ).`;
  }else{
    const nonEmptyZones = $$("#buckets .dropzone").filter(z=>z.children.length>0);
    const goodGroups = nonEmptyZones.every(z=>z.children.length===b) && (nonEmptyZones.length===q);
    ok = goodGroups && (trayCount===r);
    msg = ok
      ? `âœ… ØªÙƒÙˆÙŠÙ† ØµØ­ÙŠØ­: ${toArabicDigits(q)} Ù…Ø¬Ù…ÙˆØ¹Ø§ØªØŒ ÙÙŠ ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø© ${toArabicDigits(b)}ØŒ ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ ${toArabicDigits(r)}.`
      : `Ø­Ø§ÙˆÙ„/ÙŠ: Ù†Ø±ÙŠØ¯ ${toArabicDigits(q)} Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ÙƒØ§Ù…Ù„Ø© (ÙƒÙ„ ÙˆØ§Ø­Ø¯Ø© ${toArabicDigits(b)}) ÙˆÙŠØ¨Ù‚Ù‰ ${toArabicDigits(r)} ÙÙŠ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚.`;
  }

  const fb = $("#playFeedback");
  fb.className = "feedback " + (ok ? "good" : "bad");
  fb.innerHTML =
    msg +
    `<br>ğŸ” ØªØ­Ù‚Ù‚: ${toArabicDigits(b)} Ã— ${toArabicDigits(q)} + ${toArabicDigits(r)} = ${toArabicDigits(b*q + r)}.` +
    buildSubBoxHtml(a,b);

  if(ok){
    progress.stars += 1;
    saveProgress();
    toast("â­ Ù†Ø¬Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©!");
  }
});

/* =========================
   QUIZ
========================= */
let qState = { current:null, answered:false, score:0, streak:0 };

function pickDivisors(level){
  if(level==="easy") return [2,5,10];
  if(level==="mid") return [3,4,6,8];
  return [7,8,9,10,11,12];
}

function makeQuestion(){
  const level = $("#level").value;
  const type = $("#qType").value;
  const divs = pickDivisors(level);

  const qtype = (type==="mix") ? ["fact","word","remainder"][randInt(0,2)] : type;

  let b = divs[randInt(0, divs.length-1)];
  let q, a, r = 0;

  if(qtype==="remainder" || level==="hard"){
    q = randInt(1, 9);
    r = randInt(0, b-1);
    a = b*q + r;
    if(qtype!=="remainder" && r>0 && Math.random()<0.5) r = 0, a = b*q;
  }else{
    q = randInt(1, 10);
    a = b*q;
    r = 0;
  }

  let prompt = "", answerText = "", explanation = "";

  if(qtype==="word"){
    const contexts = [
      {emoji:"ğŸ¬", item:"Ù‚Ø·Ø¹Ø©", group:"Ø£Ø´Ø®Ø§Øµ"},
      {emoji:"â­", item:"Ù†Ø¬Ù…Ø©", group:"Ù…Ø¬Ù…ÙˆØ¹Ø§Øª"},
      {emoji:"ğŸ", item:"ØªÙØ§Ø­Ø©", group:"Ø£ØµØ¯Ù‚Ø§Ø¡"},
      {emoji:"ğŸ“š", item:"ÙƒØªØ§Ø¨", group:"Ø·Ù„Ø§Ø¨"}
    ];
    const c = contexts[randInt(0, contexts.length-1)];
    prompt = `Ù„Ø¯Ù‰ Ø§Ù„Ù…ØªØ¹Ù„Ù…/Ø© ${toArabicDigits(a)} ${c.emoji} ÙˆÙŠØ±ÙŠØ¯/ØªØ±ÙŠØ¯ ØªÙˆØ²ÙŠØ¹Ù‡Ø§ Ø¨Ø§Ù„ØªØ³Ø§ÙˆÙŠ Ø¹Ù„Ù‰ ${toArabicDigits(b)} ${c.group}. ÙƒÙ… ${c.item} Ù„ÙƒÙ„ ÙˆØ§Ø­Ø¯ØŸ`;
    answerText = toArabicDigits(q);
    explanation =
      `Ù†Ù‚Ø³Ù… ${toArabicDigits(a)} Ø¹Ù„Ù‰ ${toArabicDigits(b)}.\n`+
      `Ø§Ù„Ù†Ø§ØªØ¬ ${toArabicDigits(q)} Ù„Ø£Ù† ${toArabicDigits(b)} Ã— ${toArabicDigits(q)} = ${toArabicDigits(a)}.`;
  }else if(qtype==="remainder"){
    prompt = `Ø§Ø­Ø³Ø¨/ÙŠ: ${toArabicDigits(a)} Ã· ${toArabicDigits(b)} (Ù…Ø¹ Ø§Ù„Ø¨Ø§Ù‚ÙŠ)`;
    answerText = `${toArabicDigits(q)} ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ ${toArabicDigits(r)}`;
    explanation =
      `Ù†Ø¨Ø­Ø« Ø¹Ù† Ø£ÙƒØ¨Ø± Ù…Ø¶Ø§Ø¹Ù Ù„Ù€ ${toArabicDigits(b)} Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² ${toArabicDigits(a)}.\n`+
      `${toArabicDigits(b)} Ã— ${toArabicDigits(q)} = ${toArabicDigits(b*q)} ÙˆÙŠØªØ¨Ù‚Ù‰ ${toArabicDigits(r)}.`;
  }else{
    prompt = `Ø§Ø­Ø³Ø¨/ÙŠ: ${toArabicDigits(a)} Ã· ${toArabicDigits(b)} = ØŸ`;
    answerText = toArabicDigits(q);
    explanation =
      `Ù„Ø£Ù† ${toArabicDigits(b)} Ã— ${toArabicDigits(q)} = ${toArabicDigits(a)}.\n`+
      `Ø¥Ø°Ù† Ø§Ù„Ù†Ø§ØªØ¬ = ${toArabicDigits(q)} ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ Ù .`;
  }

  const options = new Set();
  options.add(answerText);

  while(options.size<4){
    if(qtype==="remainder"){
      const q2 = clamp(q + randInt(-2,2), 0, 12);
      const r2 = clamp(r + randInt(-2,2), 0, b-1);
      options.add(`${toArabicDigits(q2)} ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ ${toArabicDigits(r2)}`);
    }else{
      const d = clamp(q + randInt(-3,3), 0, 12);
      options.add(toArabicDigits(d));
    }
  }

  const optArr = Array.from(options);
  for(let i=optArr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [optArr[i], optArr[j]] = [optArr[j], optArr[i]];
  }

  return { prompt, answer: answerText, options: optArr, explanation, meta:{a,b,q,r,qtype} };
}

function setQuizUI(q){
  qState.current = q;
  qState.answered = false;
  $("#qText").textContent = q.prompt;

  const optionsEl = $("#options");
  clearNode(optionsEl);

  q.options.forEach(text=>{
    const b = document.createElement("button");
    b.className = "opt";
    b.textContent = text;
    b.addEventListener("click", ()=>chooseOption(text));
    optionsEl.appendChild(b);
  });

  $("#qFeedback").className = "feedback";
  $("#qFeedback").textContent = "Ø§Ø®ØªØ±/ÙŠ Ø¥Ø¬Ø§Ø¨Ø©â€¦ Ø«Ù… Ø³ÙŠØ¸Ù‡Ø± Ø´Ø±Ø­ Ø§Ù„Ø­Ù„ âœ¨";
}

function chooseOption(chosen){
  if(qState.answered || !qState.current) return;
  qState.answered = true;

  const correct = qState.current.answer;
  const all = $$("#options .opt");

  all.forEach(o=>{
    if(o.textContent===correct) o.classList.add("correct");
    if(o.textContent===chosen && chosen!==correct) o.classList.add("wrong");
    o.disabled = true;
  });

  const ok = (chosen===correct);
  const meta = qState.current.meta;

  if(ok){
    qState.score += 1;
    qState.streak += 1;
    progress.stars += 1;
    progress.score += 1;
    progress.solved += 1;
    progress.bestStreak = Math.max(progress.bestStreak, qState.streak);
    toast("â­ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!");
    $("#qFeedback").className = "feedback good";
  }else{
    progress.solved += 1;
    qState.streak = 0;
    $("#qFeedback").className = "feedback bad";
  }

  const explLines = [];
  explLines.push(ok ? "âœ… Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!" : "âŒ Ù„ÙŠØ³Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©.");
  explLines.push(`Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ${correct}`);
  explLines.push("â€”");
  explLines.push(qState.current.explanation.replace(/\n/g,"<br>"));

  const check = meta.b*meta.q + meta.r;
  explLines.push(`<br>ğŸ” ØªØ­Ù‚Ù‚: ${toArabicDigits(meta.b)} Ã— ${toArabicDigits(meta.q)} + ${toArabicDigits(meta.r)} = ${toArabicDigits(check)}.`);
  if(meta.r>0) explLines.push(`ğŸ“Œ Ø§Ù„Ø¨Ø§Ù‚ÙŠ (${toArabicDigits(meta.r)}) Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ù‚Ø³ÙˆÙ… Ø¹Ù„ÙŠÙ‡ (${toArabicDigits(meta.b)}).`);

  if(meta.a <= 60){
    explLines.push(buildSubBoxHtml(meta.a, meta.b));
  }

  $("#qFeedback").innerHTML = explLines.join("<br>");

  $("#score").textContent = toArabicDigits(qState.score);
  $("#streak").textContent = toArabicDigits(qState.streak);

  saveProgress();
}

function updateStarBar(){
  const pct = Math.min(100, (progress.stars % 10) * 10);
  $("#starBar").style.width = pct + "%";
}

$("#btnNewQ").addEventListener("click", ()=>{
  const q = makeQuestion();
  setQuizUI(q);
  $("#studentName").value = $("#studentName").value || progress.lastStudent || "";
  updateStarBar();
});

$("#btnHint").addEventListener("click", ()=>{
  if(!qState.current) return toast("Ø§Ø¨Ø¯Ø£/ÙŠ Ø¨Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯ Ø£ÙˆÙ„Ù‹Ø§.");
  const m = qState.current.meta;
  const hint =
    (m.qtype==="remainder")
    ? `ğŸ’¡ ØªÙ„Ù…ÙŠØ­: Ø§Ø¨Ø­Ø«/ÙŠ Ø¹Ù† ${toArabicDigits(m.b)}Ã—ØŸ Ù‚Ø±ÙŠØ¨ Ù…Ù† ${toArabicDigits(m.a)} Ø«Ù… Ø§Ø­Ø³Ø¨/ÙŠ Ø§Ù„Ø¨Ø§Ù‚ÙŠ.`
    : `ğŸ’¡ ØªÙ„Ù…ÙŠØ­: Ø§Ø³ØªØ®Ø¯Ù…/ÙŠ Ø§Ù„Ø¶Ø±Ø¨: ${toArabicDigits(m.b)}Ã—ØŸ = ${toArabicDigits(m.a)}.`;
  toast(hint);
});

$("#btnReadQ").addEventListener("click", ()=>{
  if(!qState.current) return toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¢Ù†.");
  speak(qState.current.prompt.replace(/Ã·/g,"Ù‚Ø³Ù…Ø©"));
});

/* =========================
   MY: Export/Import/Reset
========================= */
$("#btnExport").addEventListener("click", ()=>{
  const payload = JSON.stringify(progress, null, 2);
  const blob = new Blob([payload], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "division-progress.json";
  a.click();
  URL.revokeObjectURL(url);
  toast("ØªÙ… ØªØµØ¯ÙŠØ± JSON âœ…");
});

$("#btnImport").addEventListener("click", ()=>$("#importInput").click());
$("#importInput").addEventListener("change", (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(String(reader.result||"{}"));
      progress = { ...defaultProgress(), ...obj };
      saveProgress();
      toast("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ…");
    }catch(err){
      toast("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.");
    }
  };
  reader.readAsText(f);
});

$("#btnResetAll").addEventListener("click", ()=>{
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯/ÙŠÙ† ØªØµÙÙŠØ± Ø§Ù„ØªÙ‚Ø¯Ù…ØŸ")) return;
  progress = defaultProgress();
  saveProgress();
  toast("ØªÙ… Ø§Ù„ØªØµÙÙŠØ± âœ…");
});

/* =========================
   Print Certificate
========================= */
$("#btnPrint").addEventListener("click", ()=>{
  const name = ($("#studentName").value || progress.lastStudent || "â€”").trim();
  const cls = ($("#className").value || progress.lastClass || "â€”").trim();
  const note = ($("#note").value || progress.note || "â€”").trim();
  const now = new Date();
  const date = now.toLocaleDateString("ar-SA", {year:"numeric", month:"long", day:"numeric"});

  $("#pName").textContent = name || "â€”";
  $("#pClass").textContent = cls || "â€”";
  $("#pStars").textContent = toArabicDigits(progress.stars);
  $("#pSolved").textContent = toArabicDigits(progress.solved);
  $("#pDate").textContent = date;
  $("#pNote").textContent = note || "â€”";

  progress.lastStudent = name;
  progress.lastClass = cls;
  progress.note = note;
  saveProgress();

  window.print();
});

/* =========================
   Sync UI
========================= */
function syncProgressUI(){
  $("#starsChip").textContent = toArabicDigits(progress.stars);

  $("#myStars").textContent = toArabicDigits(progress.stars);
  $("#mySolved").textContent = toArabicDigits(progress.solved);
  $("#myBest").textContent = toArabicDigits(progress.bestStreak);

  if($("#studentName").value.trim()==="") $("#studentName").value = progress.lastStudent || "";
  if($("#className").value.trim()==="") $("#className").value = progress.lastClass || "";
  if($("#note").value.trim()==="") $("#note").value = progress.note || "";

  updateStarBar();
}
$("#studentName").addEventListener("input", ()=>{ progress.lastStudent = $("#studentName").value.trim(); saveProgress(); });
$("#className").addEventListener("input", ()=>{ progress.lastClass = $("#className").value.trim(); saveProgress(); });
$("#note").addEventListener("input", ()=>{ progress.note = $("#note").value.trim(); saveProgress(); });

/* =========================
   Init
========================= */
updateLearnEq();
syncProgressUI();
renderSubStepsBox(clamp(Number($("#learnA").value||0),0,200), clamp(Number($("#learnB").value||1),1,20));
</script>
</body>
</html>
